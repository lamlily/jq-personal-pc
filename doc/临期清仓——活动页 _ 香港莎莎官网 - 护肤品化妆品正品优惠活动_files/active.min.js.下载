
function Listeners(){this.handlers={};}
Listeners.prototype={sub:function(eventType,handler){var self=this;if(!(eventType in self.handlers)){self.handlers[eventType]=[];}
self.handlers[eventType].push(handler);return this;},pub:function(eventType){var self=this;var handlerArgs=Array.prototype.slice.call(arguments,1);for(var i=0;i<self.handlers[eventType].length;i++){self.handlers[eventType][i].apply(self,handlerArgs);}
return self;}};var Listeners=new Listeners();Listeners.sub('draw.product',function(group_id){loadGroupGoods(group_id);});window.addEvent('domready',function(){activeCountDown();drawProduct();JQ(window).scroll(function(){rabit_control();drawProduct();});JQ(window).resize(function(){rabit_control();});$('js_active_notify_used').addEvents({'click:relay(.action-notify)':function(e){var id=this.get('rel').split('::');var dialog=new Dialog($('product_notify').wrapped(),{title:'到货通知',width:450,modal:{'class':'cover'},onLoad:function(){var content=this.content;var holder=content.getElements('input[type=hidden]');var handle=content.getElement('[rel=_request]');holder[0].value=id[0];holder[1].value=id[1];handle&&handle.store('_ajax_config',{onSuccess:function(rs){if(rs&&rs[0]){if(rs[0]['true']){content.getElement('.product-notify').innerHTML='<div class="success"><i class="icon">&#x25;</i>成功提交信息，商品到货后会立刻通知您。</div>';dialog.hide.delay(3000,dialog);}}}});}});},});JQ(".rabit_nav").click(function(){JQ(window).scrollTop(JQ("#top"+JQ(this).attr("group_id")+"head").offset().top-1);});});function activeCountDown(){var status=$('actstatus').value;set_atatus_html(status);var activeid=$('js_uniquekey').getProperty('activeid');var obj=$('js_countdown');var Second=obj.getProperty('starttime');var SysSecond=parseInt(Second);if(SysSecond<1){obj.set('html',"0天0时0分0秒");}
var timer=setInterval(function(){if(SysSecond>0){SysSecond-=1;var second=Math.floor(SysSecond%60);var minite=Math.floor((SysSecond/60)%60);var hour=Math.floor((SysSecond/3600)%24);var day=Math.floor((SysSecond/3600)/24);obj.set('html',day+"天"+hour+"时"+minite+"分"+second+"秒");if(SysSecond===0){setTimeout(function(){updateActiveTime(activeid);},5000);}}else{clearInterval(timer);}},1000);}
var set_atatus_html=function(status){var wgtcontent=$('js_uniquekey');var wgttime=$('js_countdown');if(status==='0'){wgtcontent.set('html','距活动开始');}else if(status==='1'){wgtcontent.set('html','距活动完结');}else{wgtcontent.set('html','活动已结束');}}
function updateActiveTime(active_id){var url=link_site_active_ajax_update_status;var data="active_id="+active_id;var wgtcontent=$('update_timer');new Request.HTML({url:url,method:'post',data:data,update:wgtcontent,onRequest:function(){}}).send();}
var show_terms=function(type){var obj=JQ('#js_active_terms');if(type==='show'){obj.fadeIn(500);}else{obj.fadeOut(500);;}}
var rabit_control=function(){var scroH=Math.max(document.body.scrollTop,document.documentElement.scrollTop);var scroW=Math.max(JQ(window).width(),JQ(document.body).width());var clientHeight=document.documentElement.clientHeight;if(parseInt(scroW)>=1500){if(parseInt(scroH)>parseInt(clientHeight)){JQ(".rabit").fadeIn(500);}else{JQ(".rabit").fadeOut(500);}}else{JQ(".rabit").fadeOut(500);}}
function countDown(time,now,id,gid,groupid){var uniquekey=id;id='#'+id;var day_elem=JQ(id).find('.day');var hour_elem=JQ(id).find('.hour');var minute_elem=JQ(id).find('.minute');var second_elem=JQ(id).find('.second');var end_time=time*1000;var sys_second=time-now;var timer=setInterval(function(){if(sys_second>0){sys_second-=1;var day=Math.floor((sys_second/3600)/24);var hour=Math.floor((sys_second/3600)%24);var minute=Math.floor((sys_second/60)%60);var second=Math.floor(sys_second%60);day_elem&&JQ(day_elem).text(day<10?"0"+day:day);JQ(hour_elem).text(hour<10?"0"+hour:hour);JQ(minute_elem).text(minute<10?"0"+minute:minute);JQ(second_elem).text(second<10?"0"+second:second);if(day==0&&hour==0&&minute==0&&second==0){}}else{JQ(id).text('特卖已结束');clearInterval(timer);}},1000);}
function loadGroupGoods(group_id)
{var groupStatusObj=JQ("#group_status_"+group_id);var wstop=parseFloat(JQ(window).scrollTop());var topListObj=JQ("#top"+group_id+"list");var topListHtml=JQ.trim(topListObj.html());if(!topListHtml||typeof(topListHtml)=="undefined"||topListHtml==0)
{var mTop=topListObj[0].offsetTop;if(groupStatusObj.val()=="false"){groupStatusObj.val("true");console.log(mTop+":->"+wstop+",doing group "+group_id);if(group_id){JQ.ajax({url:'/active-ajax_get_group_product-'+group_id+'.html',type:'GET',data:{},dataType:'json',timeout:9000,error:function(){console.log('group '+group_id+' Error loading PHP document');},success:function(res){JQ("#top"+group_id+"list_loading").hide();topListObj.html(res);var oImgs=$$('#top'+group_id+'list .formalpic_list dd');oImgs.addEvent('mouseover',function(e){e.stopPropagation();this.getSiblings('dd').removeClass('active');this.addClass('active');this.getParent().getParent().getNext().getElement('.action-goods-img').set('src',this.getElement('img').get('switch-src'));});new DataLazyLoad({containers:topListObj,img:'data-src',lazyDataType:'img',onAfter:function(img){if(Browser.ie6)fixImageSize(img);}});miniCart.init($$("#top"+group_id+"list a[target=_dialog_minicart]"));groupStatusObj.val("false");}});}}}}